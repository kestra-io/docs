---
import Section from "~/components/layout/Section.astro"

interface Contributor {
    name: string
    avatar: string
    contributions?: number
}

let contributors: Contributor[] = []

try {
    const contributorsResponse = await fetch(
        "https://api.kestra.io/v1/communities/github/contributors",
    )
    const contributorsData = await contributorsResponse.json()
    contributors = contributorsData.data || []
} catch (error) {
    console.error("Failed to fetch contributors:", error)
}

// Sort by contributions if available
const sortedContributors = contributors.slice().sort((a, b) => {
    if (a.contributions !== undefined && b.contributions !== undefined) {
        return b.contributions - a.contributions
    }
    return 0
})

const regularCount = 24
const regularContributors = sortedContributors.slice(0, regularCount)
const moreCount = contributors.length - regularCount
---

<div class="container">
    <Section subtitle="Our contributors">
        <div id="top-of-section"></div>
        <div
            class="contributors d-flex flex-wrap justify-content-center"
            id="contributors-list"
        >
            {
                regularContributors.map((contributor) => (
                    <a
                        href={`https://github.com/${contributor.name}`}
                        target="_blank"
                        class="d-flex flex-column gap-3 align-items-center contributor-item"
                        data-usal="zoomin"
                    >
                        <img
                            width="90"
                            height="90"
                            loading="lazy"
                            class="rounded-circle"
                            src={contributor.avatar}
                            alt={contributor.name}
                        />
                        <p>{contributor.name}</p>
                    </a>
                ))
            }
        </div>
        {
            moreCount > 0 && (
                <div
                    class="text-center mt-4"
                    id="contributors-button-container"
                >
                    <button
                        type="button"
                        class="btn btn-animated btn-dark-animated"
                        data-usal="zoomin"
                        id="show-more-btn"
                        data-contributors={JSON.stringify(contributors)}
                        data-more-count={moreCount}
                    >
                        {moreCount} more contributors
                    </button>
                </div>
            )
        }
    </Section>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const showMoreBtn = document.getElementById(
            "show-more-btn",
        ) as HTMLButtonElement | null
        const contributorsList = document.getElementById("contributors-list")
        const buttonContainer = document.getElementById(
            "contributors-button-container",
        )
        const topOfSection = document.getElementById("top-of-section")

        if (!showMoreBtn || !contributorsList || !buttonContainer) return

        let isExpanded = false
        const allContributors = JSON.parse(
            showMoreBtn.dataset.contributors || "[]",
        )
        const moreCount = parseInt(showMoreBtn.dataset.moreCount || "0", 10)

        // Shuffle contributors for random display when expanded
        const shuffled = [...allContributors].sort(() => 0.5 - Math.random())

        showMoreBtn.addEventListener("click", () => {
            if (!isExpanded) {
                // Expand to show all contributors (shuffled)
                contributorsList.innerHTML = shuffled
                    .map(
                        (contributor: { name: string; avatar: string }) => `
                    <a
                        href="https://github.com/${contributor.name}"
                        target="_blank"
                        class="d-flex flex-column gap-3 align-items-center contributor-item"
                        data-usal="zoomin"
                    >
                        <img
                            width="90"
                            height="90"
                            loading="lazy"
                            class="rounded-circle"
                            src="${contributor.avatar}"
                            alt="${contributor.name}"
                        />
                        <p>${contributor.name}</p>
                    </a>
                `,
                    )
                    .join("")

                showMoreBtn.textContent = "Show less"
                showMoreBtn.classList.remove("btn-dark-animated")
                showMoreBtn.classList.add("btn-purple-animated")
                isExpanded = true
            } else {
                // Collapse back to regular contributors (sorted by contributions)
                const sorted = [...allContributors].sort(
                    (
                        a: { contributions?: number },
                        b: { contributions?: number },
                    ) => {
                        if (
                            a.contributions !== undefined &&
                            b.contributions !== undefined
                        ) {
                            return b.contributions - a.contributions
                        }
                        return 0
                    },
                )
                const regular = sorted.slice(0, 24)

                contributorsList.innerHTML = regular
                    .map(
                        (contributor: { name: string; avatar: string }) => `
                    <a
                        href="https://github.com/${contributor.name}"
                        target="_blank"
                        class="d-flex flex-column gap-3 align-items-center contributor-item"
                        data-usal="zoomin"
                    >
                        <img
                            width="90"
                            height="90"
                            loading="lazy"
                            class="rounded-circle"
                            src="${contributor.avatar}"
                            alt="${contributor.name}"
                        />
                        <p>${contributor.name}</p>
                    </a>
                `,
                    )
                    .join("")

                showMoreBtn.textContent = `${moreCount} more contributors`
                showMoreBtn.classList.remove("btn-purple-animated")
                showMoreBtn.classList.add("btn-dark-animated")
                isExpanded = false

                // Scroll back to top of section
                topOfSection?.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                })
            }
        })
    })
</script>

<style lang="scss">
    @import "~/assets/styles/variable";

    :global(section) {
        padding-bottom: 0;
    }

    .contributors {
        height: 100%;
        max-height: 100%;
        overflow: hidden;
        text-align: center;
        padding: $spacer;
        column-gap: 2rem;
        row-gap: 4rem;

        :global(a) {
            width: fit-content;

            img {
                width: 90px;
            }

            p {
                max-width: 90px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: $purple-35;
                font-size: $font-size-md;
                font-weight: 400;
            }
        }
    }
</style>
