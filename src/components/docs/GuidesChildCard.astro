---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import GuidesChildCardRender from "~/components/content/GuidesChildCard.vue";

const currentPage = Astro.url.pathname.endsWith("/")
  ? Astro.url.pathname.slice(0, -1)
  : Astro.url.pathname;

const contentPath = currentPage.replace('/docs/', '');

function getFirstContentLine(content?: string): string | undefined {
  return content?.split('\n').find(line => line.trim().length > 0 && !line.startsWith('#'));
}

const guides = await getCollection('docs').then((docs: CollectionEntry<'docs'>[]) => {
  return docs
    .filter((doc: CollectionEntry<'docs'>) => {
      return doc.id.startsWith(`${contentPath}/`) &&
             !doc.id.slice(contentPath.length + 1).includes('/');
    })
    .sort((a, b) => {
      if (a.filePath && b.filePath) {
        return a.filePath.localeCompare(b.filePath);
      }
      return a.id.localeCompare(b.id);
    })
    .map((doc: CollectionEntry<'docs'>) => ({
      title: doc.data.title,
      description: getFirstContentLine(doc.body),
      path: `/docs/${doc.id}`,
      icon: doc.data.icon,
      stage: doc.data.stage,
      topics: doc.data.topics,
    }));
});

---

<GuidesChildCardRender navigation={guides} client:load />
