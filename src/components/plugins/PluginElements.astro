---
import { subGroupName, slugify, type PluginElement, type Plugin } from "@kestra-io/ui-libs"
import { formatElementName } from "~/utils/pluginUtils"

interface Props {
    groupedElements: Record<string, PluginElement[]>
    pluginName: string
    subGroup?: Plugin
    wrapperClass?: string
    showLine?: boolean
    routeParts: string[]
}

const { groupedElements, pluginName, subGroup, wrapperClass, showLine, routeParts } = Astro.props as Props;

const getElementHref = (element: PluginElement) => {
    const base = `/plugins/${pluginName}`
    return subGroup
        ? `${base}/${slugify(subGroupName(subGroup))}/${element.cls}`
        : `${base}/${element.cls}`
}

const isElementActive = (element: PluginElement) => {
    const parts = routeParts ?? []
    return subGroup
        ? parts.length >= 3 &&
              slugify(subGroupName(subGroup)) === parts[1] &&
              slugify(element.cls) === parts[2]
        : parts.length >= 2 && slugify(element.cls) === parts[1]
}

const flatElements = Object.values(groupedElements).flat();
---

<div class:list={["subgroup-content", wrapperClass]}>
    {showLine && (
        <div class="vertical-line">
            {flatElements.map((element) => (
                <div
                    class:list={[
                        "line-segment",
                        { active: isElementActive(element) }
                    ]}
                />
            ))}
        </div>
    )}
    {Object.entries(groupedElements).map(([elementType, elements]) => (
        <div class="element-type">
            <ul class="element-list">
                {elements.map((element) => (
                    <li>
                        <a
                            href={getElementHref(element)}
                            class:list={[{ active: isElementActive(element) }]}
                        >
                            {formatElementName(element.cls)}
                        </a>
                    </li>
                ))}
            </ul>
        </div>
    ))}
</div>

<style lang="scss">
    @import "~/assets/styles/variable";

    .subgroup-content {
        position: relative;
        padding-left: 10px;
        display: flex;
        flex-direction: column;

        .vertical-line {
            position: absolute;
            left: 17px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--kestra-io-token-color-border-secondary);
            display: flex;
            flex-direction: column;

            .line-segment {
                flex: 1;
                background: $purple-36;
                opacity: 0;
                transition: opacity 0.2s ease;

                &.active {
                    opacity: 1;
                }
            }
        }

        .element-type {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacer, 1rem) / 3);
            padding-left: var(--spacer, 1rem);

            .element-list {
                list-style: none;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;

                li {
                    a {
                        display: block;
                        padding: calc(var(--spacer, 1rem) / 4);
                        font-size: $font-size-sm;
                        color: $white-1;
                        text-decoration: none;
                        border-left: 2px solid transparent;
                        transition: color 0.2s ease;

                        &:hover,
                        &.active {
                            color: $purple-36;
                        }

                        &.active {
                            font-weight: 500;
                        }
                    }
                }
            }
        }
    }
</style>
