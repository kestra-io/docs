---
import { getCollection } from "astro:content"
import { getNavigationTree } from "~/utils/getNavigationTree"
import type { NavigationItem } from "~/utils/getNavigationTree"
import ChildTableOfContentsRender from "~/components/content/ChildTableOfContents.vue"

const { pageUrl, max } = Astro.props

let currentPage = pageUrl || Astro.url.pathname
currentPage = currentPage.endsWith("/") ? currentPage.slice(0, -1) : currentPage

const contentPath = currentPage.replace("/docs/", "")

const allDocs = await getCollection("docs")
const navTree: NavigationItem[] = getNavigationTree(allDocs as any)

function findNodeByPath(
    nodes: NavigationItem[],
    path: string,
): NavigationItem | undefined {
    for (const node of nodes) {
        if (node.path === path) return node
        if (node.children) {
            const found = findNodeByPath(node.children, path)
            if (found) return found
        }
    }
    return undefined
}

const basePath = `/docs/${contentPath}`
let navigation: NavigationItem[] = []
const found: NavigationItem | undefined = findNodeByPath(navTree, basePath)

if (found && found.children) {
    navigation = found.children
} else {
    const childrenDocs = allDocs.filter(
        (doc) =>
            doc.id.startsWith(`${contentPath}/`) &&
            doc.id !== contentPath &&
            !doc.id.slice(contentPath.length + 1).includes("/"),
    )
    navigation = childrenDocs.map((doc) => ({
        title: doc.data.title,
        sidebarTitle: doc.data.sidebarTitle,
        path: `/docs/${doc.id}`,
        children: [],
    }))
}
---

<ChildTableOfContentsRender navigation={navigation} max={max} client:load />
