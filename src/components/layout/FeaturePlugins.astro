---
import { $fetchApi } from "~/utils/fetch"
import { calculateTotalPlugins } from "~/composables/usePluginsCount"
import type { Plugin } from "@kestra-io/ui-libs"

interface Props {
    content: {
        title: string
        highlight: string
        description: string
    }
}

const { content } = Astro.props

const PLUGINS = [
    { src: "/icons/io.kestra.plugin.fivetran.svg", alt: "Fivetran" },
    { src: "/icons/io.kestra.plugin.jdbc.snowflake.svg", alt: "Snowflake" },
    { src: "/icons/io.kestra.plugin.aws.svg", alt: "AWS" },
    { src: "/icons/io.kestra.plugin.databricks.svg", alt: "Databricks" },
    { src: "/icons/io.kestra.plugin.azure.svg", alt: "Azure" },
    { src: "/icons/io.kestra.plugin.dbt.svg", alt: "DBT" },
    { src: "/icons/io.kestra.plugin.airbyte.svg", alt: "Airbyte" },
    { src: "/icons/io.kestra.plugin.docker.svg", alt: "Docker" },
    { src: "/icons/io.kestra.plugin.terraform.svg", alt: "Terraform" },
    { src: "/icons/io.kestra.plugin.gcp.svg", alt: "Google Cloud" },
    { src: "/icons/io.kestra.plugin.github.svg", alt: "GitHub" },
]

const pluginGroups = await $fetchApi<Plugin[]>("/plugins/subgroups")
const totalPlugins = Math.floor(calculateTotalPlugins(pluginGroups) / 100) * 100
const displayDescription = content.description.replace(
    "{count}",
    `${totalPlugins}+`,
)
---

<section class="container-fluid">
    <div class="container">
        <div class="mb-3">
            <h1 class="title">
                {content.title}
                <span class="highlight">{content.highlight}</span>
            </h1>
            <p class="desc">{displayDescription}</p>
            <div class="plugins">
                {
                    PLUGINS.map((plugin) => (
                        <img
                            loading="lazy"
                            data-usal="fade-u delay-100"
                            src={plugin.src}
                            alt={plugin.alt}
                        />
                    ))
                }
            </div>
            <div class="d-flex justify-content-center" data-usal="zoomin">
                <a class="btn btn-gradient text-white" href="/plugins"
                    >See all plugins</a
                >
            </div>
        </div>
    </div>
</section>

<style lang="scss">
    @import "~/assets/styles/variable";

    section {
        background-color: var(--ks-background-secondary);
        border-top: $block-border;
        border-bottom: $block-border;
        padding: calc($spacer * 3) $spacer;

        .title {
            color: var(--ks-content-primary);
            text-align: center;
            font-weight: 600;
        }

        .desc {
            text-align: center;
            margin-inline: auto;
            max-width: 40%;

            @include media-breakpoint-down(lg) {
                max-width: 100%;
            }
        }
    }

    .plugins {
        display: flex;
        flex-wrap: wrap;
        gap: calc($spacer * 1.688) 4rem;
        margin: calc($spacer * 3.5) auto;
        max-width: 650px;
        place-content: center;
        align-items: center;

        img {
            width: 50px;
            height: 50px;
        }

        @include media-breakpoint-down(md) {
            width: fit-content;
            overflow-x: auto;
            margin: calc($spacer * 1.625) auto 1.5rem;
            gap: calc($spacer * 1.688) 2rem;

            img {
                max-height: calc($spacer * 3.125);
            }
        }
    }
</style>
