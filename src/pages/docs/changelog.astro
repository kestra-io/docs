---
import NavSideBar from '~/components/docs/NavSideBar.vue';
import Layout from '../../components/layout.astro';
import MDCParserAndRenderer from '~/components/plugins/MDCParserAndRenderer.vue';

function modifyCommitLink(body: string, repo = 'kestra-io/kestra') {
    const marker = 'Kestra Enterprise Edition Changes';
    const splitIndex = body.indexOf(marker);

    if (splitIndex === -1) {
        return body.replace(/^-\s([a-f0-9]{7})/gm, (match, commitId) => {
            const url = `https://github.com/${repo}/commit/${commitId}`;
            return `- [\`${commitId}\`](${url})`;
        });
    }
    const before = body.slice(0, splitIndex);
    const after = body.slice(splitIndex);

    const transformedBefore = before.replace(/^-\s([a-f0-9]{7})/gm, (match, commitId) => {
        const url = `https://github.com/${repo}/commit/${commitId}`;
        return `- [\`${commitId}\`](${url})`;
    });
    const transformedAfter = after.replace(/^-\s([a-f0-9]{7})/gm, '- ');

    return transformedBefore + transformedAfter;
}

async function fetchLast3ReleaseGroups() {
    const res = await fetch('https://api.github.com/repos/kestra-io/kestra/releases?per_page=150');
    if (!res.ok) return [];

    let data = await res.json();
    data = data.filter((r: any) => !r.draft && !r.prerelease);

    const groups: Record<string, any[]> = {};
    for (const release of data) {
        const match = release.tag_name.match(/(\d+\.\d+)/);
        if (match) {
            const key: string = match[1];
            if (!groups[key]) groups[key] = [];
            release.body = modifyCommitLink(release.body);
            groups[key].push(release);
        }
    }

    const sortedKeys = Object.keys(groups)
        .sort((a, b) => b.localeCompare(a, undefined, { numeric: true }));

    return sortedKeys.slice(0, 4).map(key => ({
        version: key,
        releases: groups[key]
    }));
}

const title = "Release Notes";
const description = "Kestra Release Notes";

const selectedGroupKey = Astro.url.searchParams.get('version');

const releaseGroups = await fetchLast3ReleaseGroups();

const selectedGroup = releaseGroups.find(g => g.version === selectedGroupKey) || releaseGroups[0];

const navMenu = [{
            children: selectedGroup.releases.map(r => ({
                title: r.tag_name,
                path: `#${r.tag_name}`
            }))
        }]
---

<Layout title={title} description={description}>
    <div class="container-fluid bd-gutter bd-layout type-docs">
        <NavSideBar type="docs" navigation={navMenu}/>
        <article class="bd-main order-1 docs full">
            <div>
                <h1>Release Notes</h1>
                <select class="form-select bg-dark-2">
                    {releaseGroups.map((g) =>
                        (<option value={g.version} selected={g.version === selectedGroupKey}>
                            { g.version }
                        </option>)
                    )}
                </select>
                <div class="bd-content" v-if="selectedGroup">
                    {selectedGroup.releases.map((release) => (
                        <div>
                            <h2 id={release.tag_name}>{ release.name || release.tag_name }</h2>
                            <MDCParserAndRenderer content={release.body} />
                            {release.body.trim() === '' && (
                                <p>No release notes available.</p>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        </article>
    </div>
</Layout>

<script>
  // Find all buttons with the `alert` class on the page.
  const select = document.querySelectorAll('select.form-select')[0];

  // Handle clicks on each button.
  select.addEventListener('change', (event) => {
    const version = (event.target as any)?.value as string;
    const url = new URL(window.location.href);
    url.searchParams.set('version', version);
    window.location.href = url.toString();
  });
</script>
