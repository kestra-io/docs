---
export const prerender = false;
import Layout from "../../components/layout.astro";
import BlueprintsHeader from "~/components/blueprints/Header.vue";
import BlueprintsDetail from "~/components/blueprints/Detail.vue";
import BlueprintsRelated from "~/components/blueprints/Related.vue";
import LayoutFooterContact from "~/components/layout/FooterContact.vue";
import { $fetch } from "~/utils/fetch";
import { parseMarkdown } from '@nuxtjs/mdc/runtime';

const { id } = Astro.params;

// Fetch blueprint data
let pageData;
let relatedBlueprints = [];
let graph = {};
let descriptionAsMd;
let flowAsMd;
let metaDescription;

try {
    pageData = await $fetch(`https://api.kestra.io/v1/blueprints/${id}/versions/latest`);
} catch (e) {
    return Astro.redirect('/404');
}

// Fetch related blueprints
if (pageData.tags && pageData.tags.length > 0) {
    const data = await $fetch(`https://api.kestra.io/v1/blueprints/versions/latest?tags=${pageData.tags}`);
    if (data) {
        const shuffleBlueprints = arr => arr.sort(() => Math.random() - 0.5);
        relatedBlueprints = shuffleBlueprints(data.results.filter(b => b.id !== pageData.id)).slice(0, 3);
    }
}

// Parse markdown
const flowMd = '```yaml\n' + pageData.flow + '\n```';
metaDescription = pageData.metaDescription;

// Fetch graph data
graph = await $fetch(`https://api.kestra.io/v1/blueprints/${id}/versions/latest/graph`);

// Fetch tags
const tags = await $fetch(`https://api.kestra.io/v1/blueprints/versions/latest/tags`);

const title = pageData.title;
const description = metaDescription;
const ogImage = `${Astro.url.origin}/og-image.png`;
---

<Layout title={title} description={description}>
    <Fragment slot="head">
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@kestra_io" />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={ogImage} />
        <meta name="twitter:image:alt" content={title} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={ogImage} />
        <meta property="og:image:type" content="image/svg+xml" />
        <meta property="og:image:alt" content={title} />
    </Fragment>

    <div>
        <BlueprintsHeader
            page={pageData}
            graph={graph}
            slug={id}
            client:only
        />
        <div class="container">
            <BlueprintsDetail
                page={pageData}
                description={pageData.description}
                flow={flowMd}
                tags={tags}
                client:visible
            />
            {relatedBlueprints.length > 0 && (
                <BlueprintsRelated
                    relatedBlueprints={relatedBlueprints}
                    tags={tags}
                    client:visible
                />
            )}
            <LayoutFooterContact
                title="New to Kestra?"
                subtitle="Use blueprints to kickstart your first workflows."
                purpleButtonText="Get started with Kestra"
                purpleButtonHref="/docs/getting-started/quickstart#start-kestra"
                client:visible
            />
        </div>
    </div>
</Layout>
