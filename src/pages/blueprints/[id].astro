---
export const prerender = false
import { $fetchApi } from "~/utils/fetch"
import Layout from "~/components/layout.astro"
import FooterContact from "~/components/layout/FooterContact.astro"
import Header from "~/components/blueprints/Header.vue"
import Detail from "~/components/blueprints/Detail.vue"
import Related from "~/components/blueprints/Related.vue"

const { id } = Astro.params

let pageData: Blueprint
let relatedBlueprints: Blueprint[] = []

try {
    pageData = await $fetchApi<Blueprint>(`/blueprints/${id}/versions/latest`)
} catch (e) {
    return Astro.redirect("/404")
}

if (pageData.tags && pageData.tags.length > 0) {
    const data = await $fetchApi<{ results: Blueprint[] }>(
        `/blueprints/versions/latest?tags=${pageData.tags}`,
    )
    if (data) {
        relatedBlueprints = data.results
            .filter((b) => b.id !== pageData.id)
            .sort(() => Math.random() - 0.5)
            .slice(0, 3)
    }
}

const flowMd = "```yaml\n" + pageData.flow + "\n```"

const graph = await $fetchApi(`/blueprints/${id}/versions/latest/graph`)

const tags = await $fetchApi(`/blueprints/versions/latest/tags`)

const title = pageData.title
const description = pageData.metaDescription
---

<Layout title={title} description={description}>
    <Header client:only page={pageData} graph={graph} slug={id} />
    <Detail
        client:visible
        page={pageData}
        description={pageData.description}
        flow={flowMd}
        tags={tags}
    />
    {
        relatedBlueprints.length > 0 && (
            <Related
                client:visible
                relatedBlueprints={relatedBlueprints}
                tags={tags}
            />
        )
    }
    <FooterContact
        client:visible
        title="New to Kestra?"
        subtitle="Use blueprints to kickstart your first workflows."
        purple={{
            text: "Get started with Kestra",
            href: "/docs/quickstart#start-kestra",
        }}
        dark={null}
    />
</Layout>
