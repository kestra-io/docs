---
import { API_URL } from "astro:env/client"
import Layout from "~/components/layout.astro"
import Intro from "~/components/infrastructure/Intro.astro"
import Deserver from "~/components/infrastructure/Deserver.astro"
import Fortune from "~/components/infrastructure/Fortune.astro"
import Govern from "~/components/infrastructure/Govern.astro"
import Tour from "~/components/infrastructure/Tour.astro"
import Operation from "~/components/infrastructure/Operation.astro"
import Automations from "~/components/infrastructure/Automations.astro"
import Lifecycle from "~/components/infrastructure/Lifecycle.astro"
import Connect from "~/components/infrastructure/Connect.astro"
import Built from "~/components/infrastructure/Built.astro"
import SeeHow from "~/components/common/SeeHow.astro"
import Architecture from "~/components/infrastructure/Architecture.astro"
import Arcade from "~/components/infrastructure/Arcade.astro"
import { formatPluginName } from "~/utils/pluginUtils"

const title =
    "Kestra: Orchestrate Your Entire Infrastructure from One Control Plane"
const description =
    "Kestra unifies provisioning, configuration, patching, remediation, compliance, and operational workflows into a single orchestration engine"

const { results: blueprints } = await fetch(
    `${API_URL}/blueprints/versions/latest?tags=infrastructure&page=1&size=20`,
).then((res) => res.json())
const tags = await fetch(`${API_URL}/blueprints/versions/latest/tags`).then(
    (res) => res.json(),
)

const plugins = Object.entries(
    (await import.meta.glob("/src/contents/docs/icons/plugins/*.svg", {
        eager: true,
    })) as Record<string, { default: { src: string } }>,
).map(([key, mod]) => ({
    name: formatPluginName(key.split("/").pop()?.replace(".svg", "") ?? ""),
    logo: mod.default,
}))
---

<Layout {title} {description}>
    <div class="infra">
        <Intro />
        <Deserver />
        <Fortune />
        <Architecture />
        <Govern />
        <Lifecycle />
        <Arcade />
        <Tour />
        <Operation />
        <Automations {blueprints} {tags} />
        <Connect {plugins} />
        <Built />
        <SeeHow>
            <Fragment slot="title">
                Ready to modernize Your Infrastructure Lifecycle?
            </Fragment>
            Teams replace vRO, Rundeck, Cron, Jenkins, and manual scripts with
            Kestra
        </SeeHow>
    </div>  
</Layout>

<style scoped lang="scss">
    @import "~/assets/styles/_variable";
    .infra {
        font-family: var(--font-family-mona-sans), sans-serif !important;
        overflow: clip;
        position: relative;

        &::after {
            content: "";
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw;
            height: 80px;
            background: rgba($white, 0.06);
            backdrop-filter: blur(2px);
            z-index: 10;
            pointer-events: none;
            -webkit-mask-image: linear-gradient(
                180deg,
                transparent 0%,
                $black 100%
            );
            mask-image: linear-gradient(180deg, transparent 0%, $black 100%);
        }
    }
</style>
