---
import Layout from "~/components/layout.astro"
import Header from "~/components/home/Header.vue"
import LogosTable from "~/components/home/LogosTable.astro"
import OpenSource from "~/components/home/OpenSource.astro"
import OpenSourceQuotes from "~/components/home/OpenSourceQuotes.vue"
import { $fetchApi } from "~/utils/fetch"
import Features from "~/components/home/Features.astro"
import EveryDev from "~/components/home/EveryDev.astro"
import Experience from "~/components/home/Experience.vue"
import BlueprintsRender from "~/components/home/BlueprintsRender.vue"
import Enterprise from "~/components/home/Enterprise.vue"
import EnterpriseQuotesRender from "~/components/home/EnterpriseQuotesRender.vue"
import CTA from "~/components/home/CTA.astro"
import PluginsBox from "~/components/PluginsBox.astro"
import { getValues } from "./api/github"
import { getImage } from "astro:assets"
import type { GetImageResult, ImageMetadata } from "astro"

const githubData = await getValues()

const blueprints = await $fetchApi<{ results: Blueprint[] }>(
    "/blueprints/versions/latest?page=1&size=20",
)
const stories = await $fetchApi<{ results: any[] }>(
    "/customer-stories-v2?featured=true",
)

const quotesCompaniesLogos = import.meta.glob<ImageMetadata>(
    "~/assets/quotes-companies/*.{svg,png}",
    {
        import: "default",
    },
)
const quotesLogos = (
    await Promise.all(
        Object.entries(quotesCompaniesLogos).map(async ([filePath, mod]) => {
            const img = await mod()
            const optimizedImage = await getImage({ src: img, height: 36 })
            return {
                name: filePath.split("/").pop(),
                img: optimizedImage,
            }
        }),
    )
).reduce(
    (acc, curr) => {
        if (curr.name) {
            acc[curr.name] = curr.img.src
        }
        return acc
    },
    {} as Record<string, string>,
)

const tabs = [
    {
        label: "CI/CD for all your Workflows",
        image: await getImage({
            src: import("~/components/home/assets/tabs/cd.png"),
            width: 1096,
            height: 590,
        }),
    },
    {
        label: "No Code, Low Code, Full Code",
        image: await getImage({
            src: import("~/components/home/assets/tabs/no-code.png"),
            width: 1096,
            height: 590,
        }),
    },
    {
        label: "Revision History & Rollback",
        image: await getImage({
            src: import("~/components/home/assets/tabs/revisions.png"),
            width: 1096,
            height: 590,
        }),
    },
    {
        label: "Alerting & Infrastructure Monitoring",
        image: await getImage({
            src: import("~/components/home/assets/tabs/alerting.png"),
            width: 1096,
            height: 590,
        }),
    },
]
---

<Layout>
    <Header client:load />
    <LogosTable />
    <OpenSource {...githubData} />
    <OpenSourceQuotes client:visible />
    <Features />
    <EveryDev />
    <Experience tabs={tabs} client:visible />
    <PluginsBox />
    <BlueprintsRender blueprints={blueprints.results} client:visible />
    <Enterprise stories={stories.results} client:visible />
    <EnterpriseQuotesRender quotesCompaniesLogos={quotesLogos} client:visible />
    <CTA />
</Layout>
