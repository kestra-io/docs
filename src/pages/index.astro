---
import Layout from "~/components/layout.astro"
import Header from "~/components/home/Header.vue"
import LogosTable from "~/components/home/LogosTable.vue"
import OpenSource from "~/components/home/OpenSource.vue"
import OpenSourceQuotes from "~/components/home/OpenSourceQuotes.vue"
import { $fetchApi } from "~/utils/fetch"
import Features from "~/components/home/Features.vue"
import EveryDev from "~/components/home/EveryDev.vue"
import Experience from "~/components/home/Experience.vue"
import BlueprintsRender from "~/components/home/BlueprintsRender.vue"
import Enterprise from "~/components/home/Enterprise.vue"
import EnterpriseQuotesRender from "~/components/home/EnterpriseQuotesRender.vue"
import CTA from "~/components/home/CTA.vue"
import PluginsBox from "~/components/PluginsBox.astro"
import { getValues } from "./api/github"
import { getImage } from "astro:assets"

const logosNonRandomized = import.meta.glob(
    "~/assets/trusted-companies/*.{svg,png}",
)
const logos = await Promise.all(
    Object.entries(logosNonRandomized).map(([filePath, mod]) => {
        return mod().then((img: any) => {
            return {
                name: filePath.split("/").pop()?.split(".").shift(),
                url: img.default.src,
            }
        })
    }),
).then((imgs: any) => imgs.toSorted(() => 0.5 - Math.random()))

const githubData = await getValues()

const blueprints = await $fetchApi<{ results: Blueprint[] }>(
    "/blueprints/versions/latest?page=1&size=20",
)
const stories = await $fetchApi<{ results: any[] }>(
    "/customer-stories-v2?featured=true",
)

const quotesCompaniesLogos = import.meta.glob(
    "~/assets/quotes-companies/*.{svg,png}",
)
const quotesLogos = (
    await Promise.all(
        Object.entries(quotesCompaniesLogos).map(([filePath, mod]) => {
            return mod().then((img: any) => {
                return {
                    name: filePath.split("/").pop(),
                    url: img.default.src,
                }
            })
        }),
    )
).reduce(
    (acc, curr) => {
        if (curr.name) {
            acc[curr.name] = curr.url
        }
        return acc
    },
    {} as Record<string, string>,
)

const tabs = [
    {
        label: "CI/CD for all your Workflows",
        image: await getImage({
            src: import("~/components/home/assets/tabs/cd.png"),
            width: 1096,
            height: 590,
        }),
    },
    {
        label: "No Code, Low Code, Full Code",
        image: await getImage({
            src: import("~/components/home/assets/tabs/no-code.png"),
            width: 1096,
            height: 590,
        }),
    },
    {
        label: "Revision History & Rollback",
        image: await getImage({
            src: import("~/components/home/assets/tabs/revisions.png"),
            width: 1096,
            height: 590,
        }),
    },
    {
        label: "Alerting & Infrastructure Monitoring",
        image: await getImage({
            src: import("~/components/home/assets/tabs/alerting.png"),
            width: 1096,
            height: 590,
        }),
    },
]
---

<Layout>
    <Header client:load />
    <LogosTable logos={logos} />
    <OpenSource {...githubData} />
    <OpenSourceQuotes client:visible />
    <Features />
    <EveryDev />
    <Experience tabs={tabs} client:visible />
    <PluginsBox />
    <BlueprintsRender blueprints={blueprints.results} client:visible />
    <Enterprise stories={stories.results} client:visible />
    <EnterpriseQuotesRender quotesCompaniesLogos={quotesLogos} client:visible />
    <CTA />
</Layout>

<script>
    const SIZE_OF_GRADIENT = 500

    // when the page has finished rendering, all the home card need a little script to react to
    // mouse movements smoothly.
    function moveGradient(e: MouseEvent) {
        const box = e.currentTarget
        if (!(box instanceof HTMLElement)) {
            return
        }

        const { left, top, width, height } = box.getBoundingClientRect()

        const x = e.clientX - left
        const y = e.clientY - top

        if (
            x < -SIZE_OF_GRADIENT ||
            x > width + SIZE_OF_GRADIENT ||
            y < -SIZE_OF_GRADIENT ||
            y > height + SIZE_OF_GRADIENT
        ) {
            return
        }
        box.style.setProperty("--x", `${x}px`)
        box.style.setProperty("--y", `${y}px`)
    }
    const cards = document.querySelectorAll(".home-card")
    for (const card of cards) {
        card.addEventListener("mousemove", moveGradient as any)
    }
</script>
