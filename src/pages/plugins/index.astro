---
import Layout from '~/components/layout.astro';
import PluginsLists from "~/components/plugins/PluginsLists.vue";
import type { Plugin, PluginMetadata } from "@kestra-io/ui-libs";
import { $fetchApi } from "~/utils/fetch";

const pluginsData = await $fetchApi<Plugin[]>(`/plugins/subgroups`)

const categoriesData = await $fetchApi<string[]>(`/plugins/categories`);

const iconsArrays = await Promise.all(pluginsData.map(async (plugin) => {
    return $fetchApi<Record<string, {icon: string}>>(`/plugins/${plugin.name}/icons/subgroups`);
}))

const plugins: Plugin[] = pluginsData.map(p => ({
    name: p.name,
    title: p.title,
    description: p.description,
    group: p.group,
    version: p.version,
    tasks: p.tasks
})) as any;

const metadata = await $fetchApi<PluginMetadata[]>(`/plugins/metadata`)

const icons = Object.fromEntries(
    iconsArrays.flatMap(icons =>
        Object.entries(icons ?? {}).map(([key, {icon}]) => [
            key,
            Buffer.from(
                Buffer.from(icon, "base64").toString("utf-8")
            ).toString("base64")
        ])
    )
);

const {countByPlugins: maybeBlueprintCounts} = await $fetchApi<{ countByPlugins: number }>(`/blueprints/countByPlugins`);

const blueprintCounts = isNaN(maybeBlueprintCounts) ? 0 : maybeBlueprintCounts;


const title = "Hundreds of Plugins For All Your Orchestrations Needs";
const description = "Connect Kestra with tools you already know and love";

---
<Layout title={title} description={description}>
    <PluginsLists
        client:idle
        {plugins}
        {icons}
        categories={categoriesData ?? []}
        fullPath={Astro.request.url}
        {metadata}
        {blueprintCounts}
    />
</Layout>