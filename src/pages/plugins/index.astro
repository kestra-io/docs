---
import Layout from "../../components/layout.astro";
import PluginsLists from "~/components/plugins/PluginsLists.vue";
import LayoutFooterContact from "~/components/layout/FooterContact.vue";
import type { Plugin, PluginMetadata } from "@kestra-io/ui-libs";
import { $fetch } from "~/utils/fetch";

const pluginsData = await $fetch<Plugin[]>("https://api.kestra.io/v1/plugins/subgroups")

const categoriesData = await $fetch<string[]>(`https://api.kestra.io/v1/plugins/categories`);

const iconsArrays = await Promise.all(pluginsData.map(async (plugin) => {
    return $fetch<Record<string, {icon: string}>>(`https://api.kestra.io/v1/plugins/${plugin.name}/icons/subgroups`);
}))

const metadata = await $fetch<PluginMetadata[]>("https://api.kestra.io/v1/plugins/metadata")

const icons = Object.fromEntries(
    iconsArrays.flatMap(icons =>
        Object.entries(icons ?? {}).map(([key, {icon}]) => [
            key,
            Buffer.from(
                Buffer.from(icon, "base64").toString("utf-8")
            ).toString("base64")
        ])
    )
);

---
<Layout>
    <PluginsLists
        plugins={pluginsData}
        icons={icons}
        categories={categoriesData ?? []}
        fullPath={Astro.request.url}
        metadata={metadata}
        client:idle
    />
    <LayoutFooterContact
        title="Didnâ€™t find the plugin you were looking for?"
        darkButtonText="Ask on slack"
        darkButtonHref="https://kestra.io/slack"
        purpleButtonText="Create one"
        purpleButtonHref="/docs/plugin-developer-guide"
    />
</Layout>